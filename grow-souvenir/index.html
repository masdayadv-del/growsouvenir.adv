<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Grow Souvenir System</title>
  
  <link rel="icon" type="image/png" href="https://i.ibb.co.com/hRvzFqBM/GROW-Logo-Transparent.png">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = { 
      theme: { 
        extend: { 
          colors: { brand: { 50:'#eff6ff', 100:'#dbeafe', 500:'#3b82f6', 600:'#2563eb', 700:'#1d4ed8', 900:'#1e3a8a' } }, 
          fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] }, 
          boxShadow: { 
            'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.07)',
            'soft': '0 4px 20px -5px rgba(0,0,0,0.05)'
          },
          animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
        } 
      } 
    }
  </script>
  <style>
    body{background-color:#F8FAFC;-webkit-tap-highlight-color:transparent}
    [x-cloak]{display:none!important}
    .no-scrollbar::-webkit-scrollbar{display:none}
    input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
    
    /* Glassmorphism */
    .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); }
    .glass-dark { background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
    .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(16px); border-top: 1px solid rgba(200, 200, 200, 0.2); }

    .fade-in{animation:fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1)}
    @keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
    
    .btn-icon{@apply w-8 h-8 flex items-center justify-center rounded-xl transition duration-200 active:scale-90}
    
    @keyframes loadingBar { 0% { transform: scaleX(0); } 50% { transform: scaleX(0.7); } 100% { transform: scaleX(1); opacity: 0; } }
    .skeleton { background: linear-gradient(to right, #f1f5f9 4%, #e2e8f0 25%, #f1f5f9 36%); background-size: 1000px 100%; animation: shimmer 2s infinite linear; }
    @keyframes shimmer { 0% { background-position: -1000px 0 } 100% { background-position: 1000px 0 } }
  </style>
</head>
<body class="h-screen flex flex-col text-slate-800 overflow-hidden bg-slate-50 selection:bg-brand-100" x-data="app()" x-init="init()">

  <div x-show="!currentUser" class="fixed inset-0 z-[200] bg-slate-100 flex flex-col items-center justify-center p-6" x-transition.opacity>
      <div class="absolute top-16 text-center">
          <p class="text-4xl font-black text-slate-200 tracking-tighter" x-text="timeString">00:00</p>
          <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1" x-text="dateString">...</p>
      </div>
      <div class="bg-white/80 backdrop-blur-xl p-8 rounded-[2.5rem] shadow-2xl w-full max-w-sm text-center border border-white relative">
          <div class="w-14 h-14 bg-gradient-to-tr from-brand-500 to-brand-700 rounded-2xl flex items-center justify-center text-white mx-auto mb-6 shadow-lg shadow-brand-500/30">
             <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
          </div>
          <h2 class="text-xl font-black text-slate-800 mb-1">Selamat Datang</h2>
          <p class="text-xs text-slate-500 mb-6 font-medium">Masuk Sistem Grow Souvenir</p>
          <form @submit.prevent="login">
              <div class="space-y-3">
                  <div class="relative"><span class="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-400"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></span><input type="text" x-model="loginForm.u" class="w-full bg-slate-50 border-0 rounded-2xl pl-10 pr-5 py-3.5 text-xs font-bold outline-none focus:ring-2 focus:ring-brand-500 transition" placeholder="Username"></div>
                  <div class="relative"><span class="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-400"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg></span><input type="password" x-model="loginForm.p" class="w-full bg-slate-50 border-0 rounded-2xl pl-10 pr-5 py-3.5 text-xs font-bold outline-none focus:ring-2 focus:ring-brand-500 transition" placeholder="Password"></div>
              </div>
              <button type="submit" :disabled="bgProcess" class="w-full mt-6 bg-brand-600 hover:bg-brand-700 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-brand-500/30 active:scale-95 transition disabled:opacity-50 flex justify-center items-center gap-2">
                  <span x-show="bgProcess" class="animate-spin w-4 h-4 border-2 border-white/30 border-t-white rounded-full"></span>
                  <span x-text="bgProcess ? 'MEMERIKSA...' : 'MASUK'"></span>
              </button>
          </form>
      </div>
  </div>

  <div x-show="currentUser" class="flex flex-col h-full fade-in">
      
      <header class="glass-nav sticky top-0 z-30 px-6 py-4 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 bg-gradient-to-br from-brand-600 to-brand-800 rounded-xl flex items-center justify-center text-white shadow-lg shadow-brand-500/30">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
          </div>
          <div>
            <h1 class="text-base font-black text-slate-900 leading-none tracking-tight">GROW<span class="text-brand-600">SOUVENIR</span></h1>
            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">System v19</p>
          </div>
        </div>
        <div @click="isLogoutOpen = true; vibrate()" class="flex items-center gap-3 pl-4 border-l border-slate-200 cursor-pointer group">
           <div class="text-right hidden sm:block">
               <p class="text-[10px] font-bold text-slate-800" x-text="greeting + ', ' + (currentUser?.name?.split(' ')[0] || 'User')"></p>
               <p class="text-[9px] font-bold text-brand-600 uppercase tracking-wide text-right" x-text="currentUser?.role"></p>
           </div>
           <div class="w-9 h-9 rounded-full bg-slate-100 border border-slate-200 flex items-center justify-center text-slate-500 shadow-sm group-active:scale-95 transition overflow-hidden">
               <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M18.685 19.097A9.723 9.723 0 0021.75 12c0-5.385-4.365-9.75-9.75-9.75S2.25 6.615 2.25 12a9.723 9.723 0 003.065 7.097A9.716 9.716 0 0012 21.75a9.716 9.716 0 006.685-2.653zm-12.54-1.285A7.486 7.486 0 0112 15a7.486 7.486 0 015.855 2.812A8.224 8.224 0 0112 20.25a8.224 8.224 0 01-5.855-2.438zM15.75 9a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" clip-rule="evenodd" /></svg>
           </div>
        </div>
      </header>

      <div class="fixed top-24 left-1/2 -translate-x-1/2 z-[100] w-[90%] max-w-sm flex flex-col gap-2 pointer-events-none">
        <template x-for="notif in notifications" :key="notif.id">
            <div class="px-4 py-2.5 rounded-xl shadow-xl flex items-center gap-3 backdrop-blur-md pointer-events-auto transform transition-all duration-300 fade-in border"
                 :class="notif.type === 'error' ? 'bg-white border-rose-100 text-rose-600' : 'bg-slate-800 border-slate-700 text-white'">
                <div x-show="notif.type !== 'error'"><svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>
                <div x-show="notif.type === 'error'"><svg class="w-4 h-4 text-rose-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div>
                <span class="text-xs font-bold tracking-wide" x-text="notif.message"></span>
            </div>
        </template>
      </div>

      <main class="flex-1 overflow-y-auto no-scrollbar p-5 pb-36 relative">
        
        <div x-show="initialLoading" 
             x-transition:leave="transition ease-in duration-500" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
             class="fixed inset-0 z-[100] bg-slate-50 flex flex-col items-center justify-center p-6">
          <div class="relative w-16 h-16 mb-6">
             <div class="absolute inset-0 bg-brand-500 rounded-full opacity-20 animate-ping"></div>
             <div class="relative bg-white p-3 rounded-full shadow-xl border border-slate-100 flex items-center justify-center">
                <svg class="w-8 h-8 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
             </div>
          </div>
          <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest animate-pulse" x-text="loadingText">MEMUAT...</p>
        </div>

        <div x-show="tab === 'home'" class="space-y-5 max-w-md mx-auto fade-in">
          <div class="flex justify-between items-center px-1">
              <p class="text-xs font-bold text-slate-500 uppercase tracking-wide flex items-center gap-2"><span class="w-1.5 h-1.5 bg-brand-500 rounded-full"></span> Ringkasan</p>
              <div class="flex items-center gap-2">
                  <p class="text-[9px] font-bold text-slate-400" x-text="dateString"></p>
                  <button @click="fetch(true); vibrate()" class="p-1 rounded-full bg-white text-slate-400 hover:text-brand-600 border border-slate-100 shadow-sm"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg></button>
              </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div @click="tab='list'; vibrate()" class="glass-card p-5 rounded-[2rem] shadow-soft relative overflow-hidden cursor-pointer active:scale-95 transition flex flex-col justify-between h-full group">
              <div class="absolute top-0 right-0 w-20 h-20 bg-blue-50 rounded-full blur-2xl -mr-8 -mt-8 opacity-60"></div>
              <div>
                  <div class="w-8 h-8 rounded-xl bg-blue-50 text-brand-600 flex items-center justify-center mb-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg></div>
                  <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wide">Omzet</p>
                  <p x-show="!loadingData" class="text-lg font-black text-slate-800 leading-tight" x-text="fmt(stats.omzet)"></p>
                  <div x-show="loadingData" class="h-6 w-20 skeleton rounded mt-1"></div>
              </div>
            </div>
            
            <div class="glass-card p-5 rounded-[2rem] shadow-soft relative overflow-hidden flex flex-col justify-between">
                 <div class="absolute top-0 right-0 w-20 h-20 bg-emerald-50 rounded-full blur-2xl -mr-8 -mt-8 opacity-60"></div>
                 
                 <div @click="tab='list'; vibrate()" class="cursor-pointer mb-3">
                     <div class="w-8 h-8 rounded-xl bg-emerald-50 text-emerald-600 flex items-center justify-center mb-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                     <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wide">Profit Bersih</p>
                     <p x-show="!loadingData" class="text-lg font-black text-emerald-600 leading-tight" x-text="fmt(stats.netProfit)"></p>
                     <div x-show="loadingData" class="h-6 w-20 skeleton rounded mt-1"></div>
                 </div>

                 <div @click="tab='expense'; vibrate()" class="flex items-center gap-1.5 cursor-pointer opacity-80 hover:opacity-100 transition mt-1">
                     <svg class="w-3 h-3 text-rose-500 animate-pulse-slow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
                     <p x-show="!loadingData" class="text-[10px] font-bold text-rose-500" x-text="fmt(stats.totalExpense)"></p>
                     <div x-show="loadingData" class="h-2 w-10 skeleton rounded"></div>
                 </div>
            </div>
          </div>

          <div class="glass-dark text-white p-6 rounded-[2.5rem] shadow-xl relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-10"><svg class="w-20 h-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div>
            <div class="relative z-10">
              <p class="text-[9px] font-bold uppercase tracking-[0.2em] opacity-60 mb-1">UANG FISIK DI LACI</p>
              <div class="flex items-end justify-between">
                  <h2 x-show="!loadingData" class="text-2xl font-black text-amber-400 tracking-tight" x-text="fmt(modalStats.modalGantung)"></h2>
                  <div x-show="loadingData" class="h-8 w-24 bg-white/10 rounded animate-pulse"></div>
                  <button @click="openSetorModal()" class="bg-white text-slate-900 text-[9px] font-bold px-4 py-2 rounded-full active:scale-95 transition shadow hover:bg-slate-100 flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg> SETOR</button>
              </div>
              <div class="mt-3 pt-3 border-t border-white/10 flex gap-4">
                  <div><p class="text-[8px] opacity-50 uppercase">Total Disetor</p><p class="text-[9px] font-bold" x-text="fmt(modalStats.totalDisetor)"></p></div>
                  <div><p class="text-[8px] opacity-50 uppercase">Total HPP</p><p class="text-[9px] font-bold text-rose-300" x-text="fmt(modalStats.totalHPP)"></p></div>
              </div>
            </div>
          </div>

          <div class="bg-white p-5 rounded-[2rem] border border-slate-50 shadow-soft">
              <div class="flex items-center justify-between mb-4">
                  <h3 class="text-xs font-bold text-slate-800 uppercase tracking-wider flex items-center gap-2"><span class="w-1 h-3 bg-brand-500 rounded-full"></span> Terakhir</h3>
                  <button @click="tab='list'; vibrate()" class="text-[9px] font-bold text-brand-600 hover:underline">Lihat Semua</button>
              </div>
              <div class="space-y-3">
                  <template x-if="loadingData"><div class="space-y-2"><div class="h-8 skeleton rounded-lg"></div><div class="h-8 skeleton rounded-lg"></div></div></template>
                  <template x-for="t in history.slice(0, 5)" :key="t.id">
                      <div @click="viewDetail(t); vibrate()" class="flex justify-between items-center py-2 border-b border-slate-50 last:border-0 cursor-pointer active:opacity-50">
                          <div><p class="text-xs font-bold text-slate-800 line-clamp-1" x-text="t.product"></p><p class="text-[9px] text-slate-400" x-text="t.customer"></p></div>
                          <p class="text-xs font-black text-slate-700" x-text="fmt(t.total)"></p>
                      </div>
                  </template>
                  <div x-show="!loadingData && history.length === 0" class="text-center py-2 text-[10px] text-slate-400">Belum ada data.</div>
              </div>
          </div>
        </div>

        <div x-show="tab === 'list'" class="max-w-md mx-auto fade-in">
            <div class="bg-white/90 backdrop-blur-sm p-3 rounded-2xl border border-slate-100 mb-4 shadow-sm sticky top-0 z-20 flex justify-between items-center">
                <span class="text-[10px] font-bold text-slate-400 uppercase">Riwayat</span>
                <input type="date" x-model="filterDate" class="bg-white rounded-lg px-2 py-1 text-[9px] font-bold border border-slate-200 outline-none text-slate-600">
            </div>
            
            <div class="space-y-3 pb-4">
              <template x-for="t in filteredHistory" :key="t.id">
                <div @click="viewDetail(t); vibrate()" class="bg-white p-4 rounded-[1.5rem] border border-slate-50 shadow-soft relative active:scale-[0.99] transition">
                   <div class="flex justify-between items-start mb-2">
                      <div class="flex-1 pr-2">
                          <span class="text-[8px] font-extrabold px-1.5 py-0.5 rounded border mb-1 inline-block" :class="t.status === 'LUNAS' ? 'bg-emerald-50 text-emerald-600 border-emerald-100' : 'bg-rose-50 text-rose-600 border-rose-100'" x-text="t.status"></span>
                          <h4 class="font-bold text-xs text-slate-800 line-clamp-1" x-text="t.product"></h4>
                          <p class="text-[9px] font-bold uppercase text-slate-400" x-text="t.customer"></p>
                      </div>
                      <div class="text-right">
                          <p class="font-black text-xs text-brand-600" x-text="fmt(t.total)"></p>
                          <p class="text-[8px] text-rose-500 font-bold" x-show="t.sisa > 0" x-text="'Kurang: ' + fmt(t.sisa)"></p>
                      </div>
                   </div>
                   <div class="flex justify-end gap-2 border-t border-slate-50 pt-2">
                      <button @click.stop="editItem(t); vibrate()" class="flex items-center px-3 py-1 bg-blue-50 text-blue-600 rounded-lg text-[9px] font-bold active:bg-blue-100 hover:bg-blue-100 transition"><svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>Edit</button>
                      <button @click.stop="printInvoice(t.id); vibrate()" class="flex items-center px-3 py-1 bg-slate-50 text-slate-600 rounded-lg text-[9px] font-bold active:bg-slate-100 hover:bg-slate-100 transition"><svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2.4-9h6m-6 6h6m-6-10h6m-6 6h6m2-14H5a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 00-2-2V5a2 2 0 00-2-2z"></path></svg>Print</button>
                      <template x-if="currentUser.role === 'Admin'">
                        <button @click.stop="requestDelete(t.id); vibrate()" class="flex items-center px-3 py-1 bg-rose-50 text-rose-600 rounded-lg text-[9px] font-bold active:bg-rose-100 hover:bg-rose-100 transition"><svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>Hapus</button>
                      </template>
                   </div>
                </div>
              </template>
              <div x-show="filteredHistory.length === 0" class="text-center py-10 text-xs text-slate-400">Tidak ada data.</div>
            </div>
        </div>

        <div x-show="tab === 'add'" class="space-y-5 max-w-md mx-auto fade-in">
          <div class="bg-white rounded-[2.5rem] border border-slate-50 shadow-soft p-6">
            <h2 class="text-sm font-bold text-slate-800 uppercase mb-5 text-center flex items-center justify-center gap-2"><span class="w-1.5 h-1.5 bg-brand-600 rounded-full"></span> <span x-text="form.id ? 'Edit Transaksi' : 'Transaksi Baru'"></span></h2>
            <div class="space-y-3">
                 <div class="flex gap-2"><input type="text" x-model="form.customer" class="flex-1 bg-slate-50 border-0 rounded-xl px-4 py-3 text-xs font-bold outline-none focus:ring-2 focus:ring-brand-500" placeholder="Pelanggan"><input type="date" x-model="form.deadline" class="w-24 bg-slate-50 border-0 rounded-xl px-2 py-3 text-xs font-bold outline-none focus:ring-2 focus:ring-brand-500 text-slate-500"></div>
                 
                 <div class="p-3 bg-slate-50 rounded-2xl border border-slate-100 space-y-2">
                     <div class="flex gap-2 mb-2">
                        <button @click="isService=false; vibrate()" class="flex-1 py-2 rounded-lg text-[9px] font-bold transition" :class="!isService ? 'bg-white shadow text-brand-600' : 'text-slate-400'">BARANG</button>
                        <button @click="isService=true; vibrate()" class="flex-1 py-2 rounded-lg text-[9px] font-bold transition" :class="isService ? 'bg-white shadow text-brand-600' : 'text-slate-400'">JASA</button>
                        <button @click="isMasterOpen=true; vibrate()" class="w-8 bg-white rounded-lg flex items-center justify-center text-slate-400 active:scale-95 shadow-sm">+</button>
                     </div>
                     <div x-show="!isService" class="relative">
                        <input type="text" x-model="productSearch" @focus="showProductList=true" @click.away="showProductList=false" placeholder="Cari produk..." class="w-full bg-white border-0 rounded-xl px-4 py-3 text-xs font-bold outline-none focus:ring-2 focus:ring-brand-500 shadow-sm">
                        <div x-show="showProductList && productSearch && filteredProducts.length > 0" class="absolute top-full left-0 w-full mt-1 bg-white rounded-xl shadow-xl border border-slate-100 max-h-40 overflow-y-auto z-50 p-1">
                            <template x-for="p in filteredProducts" :key="p.name"><div @click="form.productName = '['+p.category+'] '+p.name; productSearch = p.name; showProductList = false; vibrate()" class="px-3 py-2 hover:bg-brand-50 rounded-lg cursor-pointer transition"><p class="text-xs font-bold text-slate-800" x-text="p.name"></p><p class="text-[9px] text-slate-400" x-text="p.category"></p></div></template>
                        </div>
                     </div>
                     <div x-show="isService"><input type="text" x-model="form.serviceName" class="w-full bg-white border-0 rounded-xl px-4 py-3 text-xs font-bold outline-none focus:ring-2 focus:ring-brand-500 shadow-sm" placeholder="Nama Jasa"></div>
                     <div class="flex gap-2">
                         <input type="number" x-model="form.qty" class="w-16 bg-white border-0 rounded-xl px-2 py-3 text-center text-xs font-bold outline-none focus:ring-2 focus:ring-brand-500 shadow-sm" placeholder="Qty">
                         <div class="flex-1 relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-[9px] font-bold text-slate-400">Rp</span><input type="number" x-model="form.sellPrice" class="w-full bg-white border-0 rounded-xl pl-8 pr-3 py-3 text-right text-xs font-bold outline-none focus:ring-2 focus:ring-brand-500 text-brand-700 shadow-sm" placeholder="Harga Jual"></div>
                     </div>
                     <div x-show="!isService" class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-[9px] font-bold text-slate-400">Rp</span><input type="number" x-model="form.costPrice" class="w-full bg-white border-0 rounded-xl pl-8 pr-3 py-3 text-right text-xs font-bold outline-none focus:ring-2 focus:ring-slate-400 text-slate-500 shadow-sm" placeholder="Harga Modal"></div>
                     <button @click="addToCart(); vibrate()" class="w-full bg-slate-900 text-white font-bold py-3 rounded-xl text-xs active:scale-95 transition shadow-lg shadow-slate-500/20">TAMBAH</button>
                 </div>
                 
                 <div x-show="cart.length > 0" class="space-y-2">
                     <template x-for="(item, index) in cart" :key="index">
                         <div class="bg-white p-3 rounded-xl border border-slate-100 flex justify-between items-center shadow-sm">
                             <div><p class="text-xs font-bold text-slate-800" x-text="item.productName"></p><p class="text-[9px] text-slate-500"><span x-text="item.qty"></span> x <span x-text="fmt(item.sellPrice)"></span></p></div>
                             <div class="flex items-center gap-2"><p class="text-xs font-bold text-brand-600" x-text="fmt(item.qty * item.sellPrice)"></p><button @click="cart.splice(index, 1); vibrate()" class="text-red-400"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div>
                         </div>
                     </template>
                     <div class="flex justify-between items-center px-2"><span class="text-xs font-bold text-slate-500">Total</span><span class="text-sm font-extrabold text-slate-800" x-text="fmt(cartTotal)"></span></div>
                 </div>
                 
                 <div x-show="cart.length > 0" class="bg-amber-50 p-3 rounded-2xl border border-amber-100">
                    <div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-[9px] font-bold text-amber-500">DP</span><input type="number" x-model="form.dp" class="w-full bg-white rounded-xl pl-8 pr-3 py-3 text-right text-xs font-bold outline-none focus:ring-2 focus:ring-amber-500 transition shadow-sm" placeholder="0"></div>
                    <div class="flex gap-2 mt-2 overflow-x-auto no-scrollbar"><button @click="form.dp = cartTotal; vibrate()" class="px-3 py-1 bg-white border border-slate-200 rounded-lg text-[8px] font-bold">Lunas</button><button @click="form.dp = 50000; vibrate()" class="px-3 py-1 bg-white border border-slate-200 rounded-lg text-[8px] font-bold">50k</button><button @click="form.dp = 100000; vibrate()" class="px-3 py-1 bg-white border border-slate-200 rounded-lg text-[8px] font-bold">100k</button></div>
                 </div>
            </div>
            <div class="flex gap-3 mt-5">
                <button type="button" @click="resetForm(); tab='list'; vibrate()" class="flex-1 bg-white border border-slate-200 text-slate-500 py-3 rounded-xl font-bold text-xs hover:bg-slate-50">Batal</button>
                <button type="button" @click="save" :disabled="bgProcess || cart.length === 0" class="flex-1 bg-brand-600 text-white font-bold py-3 rounded-xl text-xs shadow-lg active:scale-95 disabled:opacity-50">SIMPAN</button>
            </div>
          </div>
        </div>

        <div x-show="tab === 'expense'" class="space-y-5 max-w-md mx-auto fade-in">
            <div class="glass-card px-4 py-3 rounded-xl flex justify-between items-center shadow-sm">
                 <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Total Keluar</span>
                 <span class="text-sm font-black text-rose-500" x-text="fmt(stats.totalExpense)"></span>
            </div>

            <div class="bg-white rounded-[2.5rem] border border-slate-50 shadow-soft p-6">
                <h2 class="text-sm font-bold text-slate-800 uppercase mb-4 tracking-wide text-center">Catat Biaya</h2>
                <form @submit.prevent="submitExpense"><div class="space-y-3"><select x-model="expForm.category" class="w-full bg-slate-50 border-0 rounded-2xl px-4 py-3 text-xs font-bold outline-none focus:ring-2 focus:ring-rose-500"><option value="" disabled>Pilih Kategori</option><option>Operasional</option><option>Bahan Baku</option><option>Gaji</option><option>Transportasi</option><option>Lainnya</option></select><input type="text" x-model="expForm.desc" class="w-full bg-slate-50 border-0 rounded-2xl px-4 py-3 text-xs font-bold outline-none focus:ring-2 focus:ring-rose-500" placeholder="Keterangan"><div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 text-[9px] font-bold text-rose-300">Rp</span><input type="number" x-model="expForm.amount" class="w-full bg-slate-50 border-0 rounded-2xl pl-8 pr-4 py-3 text-xs font-bold outline-none focus:ring-2 focus:ring-rose-500" placeholder="Nominal"></div></div><button type="submit" :disabled="bgProcess" class="w-full mt-5 bg-rose-600 text-white font-bold py-3.5 rounded-2xl text-xs shadow-lg active:scale-95 flex justify-center gap-2"><span x-show="bgProcess" class="animate-spin w-3 h-3 border-2 border-white/30 border-t-white rounded-full"></span><span x-text="bgProcess ? 'MENYIMPAN...' : 'SIMPAN'"></span></button></form>
            </div>
            
            <div class="space-y-3 pb-4">
                <template x-for="ex in expenses" :key="ex.id">
                    <div class="bg-white p-3 rounded-2xl border border-slate-50 shadow-soft flex justify-between items-center">
                        <div><p class="text-xs font-bold text-slate-800" x-text="ex.desc"></p><div class="flex gap-2 mt-0.5"><span class="text-[9px] text-slate-400" x-text="ex.date"></span><span class="text-[8px] font-bold bg-slate-100 text-slate-500 px-1.5 rounded" x-text="ex.cat"></span></div></div>
                        <p class="text-xs font-black text-rose-500" x-text="fmt(ex.amount)"></p>
                    </div>
                </template>
            </div>
        </div>

        <div x-show="tab === 'report'" class="space-y-5 max-w-md mx-auto fade-in">
            <h2 class="text-sm font-bold text-slate-800 uppercase mb-4 ml-2">Pusat Laporan</h2>
            <div class="grid grid-cols-1 gap-3">
                <button @click="printMonthly" class="bg-gradient-to-r from-indigo-500 to-indigo-600 p-5 rounded-[2rem] text-white shadow-lg active:scale-95 transition flex justify-between items-center"><div><p class="text-base font-extrabold">Bulanan</p><p class="text-[10px] opacity-80">Download PDF</p></div><div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center"><span x-show="!loadingPdf"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></span><span x-show="loadingPdf" class="animate-spin w-4 h-4 border-2 border-white rounded-full border-t-transparent"></span></div></button>
                <button @click="printExpenseReport" class="bg-gradient-to-r from-rose-500 to-rose-600 p-5 rounded-[2rem] text-white shadow-lg active:scale-95 transition flex justify-between items-center"><div><p class="text-base font-extrabold">Pengeluaran</p><p class="text-[10px] opacity-80">Download PDF</p></div><div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></div></button>
                <button @click="printAnnual" class="bg-gradient-to-r from-amber-500 to-orange-500 p-5 rounded-[2rem] text-white shadow-lg active:scale-95 transition flex justify-between items-center"><div><p class="text-base font-extrabold">Tahunan</p><p class="text-[10px] opacity-80">Download PDF</p></div><div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></div></button>
            </div>
        </div>
      </main>

      <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 glass-nav px-4 py-3 z-40 flex items-center gap-2 w-[95%] max-w-sm justify-between rounded-full shadow-2xl shadow-slate-300/50">
        <button @click="tab='home'; vibrate()" class="p-2 rounded-full transition duration-300" :class="tab==='home'?'text-brand-600 bg-brand-50':'text-slate-400 hover:text-slate-600'"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg></button>
        <button @click="tab='list'; vibrate()" class="p-2 rounded-full transition duration-300" :class="tab==='list'?'text-brand-600 bg-brand-50':'text-slate-400 hover:text-slate-600'"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg></button>
        <button @click="resetForm(); tab='add'; vibrate()" class="w-14 h-14 bg-gradient-to-b from-brand-600 to-brand-700 rounded-full text-white shadow-xl shadow-brand-500/40 flex items-center justify-center transform transition hover:scale-110 active:scale-95 -mt-8 border-[4px] border-[#F1F5F9]"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg></button>
        <button @click="tab='expense'; vibrate()" class="p-2 rounded-full transition duration-300" :class="tab==='expense'?'text-red-500 bg-red-50':'text-slate-400 hover:text-slate-600'"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button>
        <button x-show="currentUser?.role === 'Admin'" @click="tab='report'; vibrate()" class="p-2 rounded-full transition duration-300" :class="tab==='report'?'text-amber-500 bg-amber-50':'text-slate-400 hover:text-slate-600'"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></button>
      </nav>
  </div>

  <div x-show="isDeleteOpen" class="fixed inset-0 z-[90] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-6" x-cloak><div class="bg-white rounded-[2rem] w-full max-w-xs p-6 shadow-2xl text-center"><div class="mx-auto w-12 h-12 bg-red-50 rounded-full flex items-center justify-center mb-3 text-red-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></div><h3 class="font-extrabold text-slate-800">Hapus Data?</h3><div class="flex gap-2 mt-4"><button @click="isDeleteOpen=false" class="flex-1 bg-slate-100 py-3 rounded-xl text-xs font-bold text-slate-500">Batal</button><button @click="confirmDelete" class="flex-1 bg-red-600 text-white py-3 rounded-xl text-xs font-bold shadow-lg">Hapus</button></div></div></div>
  <div x-show="isMasterOpen" class="fixed inset-0 z-[80] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-6" x-cloak><div class="bg-white rounded-[2rem] w-full max-w-sm p-6 shadow-2xl space-y-4"><h3 class="font-extrabold text-slate-800 text-lg flex items-center gap-2"><span class="w-1.5 h-6 bg-brand-600 rounded-full"></span> Tambah Produk</h3><input type="text" x-model="newProd.category" list="catList" class="w-full bg-slate-50 border-0 rounded-xl p-4 text-xs font-bold outline-none focus:ring-2 focus:ring-brand-500" placeholder="Kategori"><datalist id="catList"><template x-for="c in categories" :key="c"><option :value="c"></option></template></datalist><input type="text" x-model="newProd.name" class="w-full bg-slate-50 border-0 rounded-xl p-4 text-xs font-bold outline-none focus:ring-2 focus:ring-brand-500" placeholder="Nama Produk"><div class="flex gap-2 pt-2"><button @click="isMasterOpen=false" class="flex-1 bg-slate-100 py-3.5 rounded-xl text-xs font-bold text-slate-500">Batal</button><button @click="submitNewProd" :disabled="bgProcess" class="flex-1 bg-brand-600 text-white py-3.5 rounded-xl text-xs font-bold shadow-lg">Simpan</button></div></div></div>
  
  <div x-show="isSetorOpen" class="fixed inset-0 z-[80] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-6" x-cloak>
      <div class="bg-white rounded-[2.5rem] w-full max-w-sm p-6 shadow-2xl space-y-4 text-center">
          <h3 class="font-extrabold text-slate-800 text-lg">Setor Modal</h3>
          <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200"><div class="flex justify-between items-center text-xs font-bold text-slate-400 uppercase tracking-wide"><span>Saldo Laci</span><span class="text-slate-800 text-sm" x-text="fmt(modalStats.modalGantung)"></span></div></div>
          <div class="relative"><span class="absolute left-5 top-1/2 -translate-y-1/2 text-[10px] font-bold text-brand-400">Rp</span><input type="number" x-model="setorForm.amount" class="w-full bg-slate-50 border-0 rounded-2xl pl-10 pr-5 py-4 text-sm font-bold outline-none focus:ring-2 focus:ring-brand-500 transition" placeholder="Nominal Disetor"></div>
          <input type="text" x-model="setorForm.note" class="w-full bg-slate-50 border-0 rounded-2xl px-5 py-4 text-xs font-bold outline-none focus:ring-2 focus:ring-brand-500 transition" placeholder="Keterangan">
          <div class="flex gap-2 justify-center"><button @click="setorForm.note='Setor ke Mandiri'; vibrate()" class="px-3 py-1.5 rounded-lg border border-slate-200 text-[10px] font-bold text-slate-500 active:bg-brand-50 active:border-brand-500 transition">Ke Mandiri</button><button @click="setorForm.note='Setor ke BCA'; vibrate()" class="px-3 py-1.5 rounded-lg border border-slate-200 text-[10px] font-bold text-slate-500 active:bg-brand-50 active:border-brand-500 transition">Ke BCA</button></div>
          <div class="flex gap-2 pt-2"><button @click="isSetorOpen=false" class="flex-1 bg-slate-100 py-3.5 rounded-xl text-xs font-bold text-slate-500">Batal</button><button @click="submitSetor" class="flex-1 bg-brand-600 text-white py-3.5 rounded-xl text-xs font-bold shadow-lg">Konfirmasi</button></div>
      </div>
  </div>

  <div x-show="isLogoutOpen" class="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-6" x-cloak><div class="bg-white rounded-[2rem] w-full max-w-xs p-6 shadow-2xl text-center fade-in"><div class="mx-auto w-14 h-14 bg-red-50 rounded-full flex items-center justify-center mb-4 text-red-500"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg></div><h3 class="font-extrabold text-slate-800 text-lg">Keluar Aplikasi?</h3><p class="text-xs text-slate-500 mt-2 leading-relaxed">Anda harus login ulang untuk masuk kembali ke sistem.</p><div class="flex gap-3 mt-6"><button @click="isLogoutOpen=false" class="flex-1 bg-slate-100 py-3.5 rounded-xl text-xs font-bold text-slate-500 hover:bg-slate-200 transition">Batal</button><button @click="logout" class="flex-1 bg-red-600 text-white py-3.5 rounded-xl text-xs font-bold shadow-lg hover:bg-red-700 transition">Keluar</button></div></div></div>

  <div x-show="isDetailOpen" class="fixed inset-0 z-[90] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 sm:p-6" x-cloak>
      <div class="bg-white rounded-[2.5rem] w-full max-w-md shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
          <div class="p-6 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
              <div><h3 class="font-extrabold text-slate-800 text-lg">Detail Transaksi</h3><p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider" x-text="selectedDetail?.id"></p></div>
              <button @click="isDetailOpen=false" class="w-8 h-8 rounded-full bg-white border border-slate-200 text-slate-400 flex items-center justify-center hover:bg-slate-100"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
          </div>
          <div class="p-6 overflow-y-auto no-scrollbar space-y-6">
              <div class="grid grid-cols-2 gap-4">
                  <div class="bg-slate-50 p-3 rounded-2xl border border-slate-100"><p class="text-[9px] font-bold text-slate-400 uppercase">Pelanggan</p><p class="font-bold text-slate-800 text-sm mt-0.5" x-text="selectedDetail?.customer"></p></div>
                  <div class="bg-slate-50 p-3 rounded-2xl border border-slate-100"><p class="text-[9px] font-bold text-slate-400 uppercase">Tanggal</p><p class="font-bold text-slate-800 text-sm mt-0.5" x-text="selectedDetail?.displayDate"></p></div>
              </div>
              <div>
                  <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Rincian Barang</p>
                  <div x-show="loadingDetail" class="space-y-2"><div class="h-10 bg-slate-100 rounded-xl animate-pulse"></div></div>
                  <div x-show="!loadingDetail" class="space-y-3">
                      <template x-for="item in detailItems" :key="item.productName">
                          <div class="flex justify-between items-start border-b border-slate-50 pb-2 last:border-0">
                              <div class="pr-2">
                                  <p class="text-xs font-bold text-slate-800" x-text="item.productName"></p>
                                  <p class="text-[10px] text-slate-400"><span x-text="item.qty"></span> x <span x-text="fmt(item.sellPrice)"></span></p>
                                  <template x-if="currentUser.role === 'Admin'">
                                      <p class="text-[9px] text-slate-400 mt-0.5">HPP: <span x-text="fmt(item.costPrice)"></span> â€¢ Laba: <span class="text-emerald-500 font-bold" x-text="fmt((item.sellPrice - item.costPrice) * item.qty)"></span></p>
                                  </template>
                              </div>
                              <p class="text-xs font-black text-brand-600" x-text="fmt(item.sellPrice * item.qty)"></p>
                          </div>
                      </template>
                  </div>
              </div>
              <div class="bg-slate-900 rounded-2xl p-4 text-white space-y-2">
                  <div class="flex justify-between text-xs opacity-70"><span>Total Tagihan</span><span x-text="fmt(selectedDetail?.total)"></span></div>
                  <div class="flex justify-between text-xs opacity-70"><span>Sudah Bayar (DP)</span><span class="text-green-400" x-text="fmt(selectedDetail?.dp)"></span></div>
                  <div class="w-full h-px bg-white/10 my-1"></div>
                  <div class="flex justify-between font-bold text-sm"><span>Sisa Kekurangan</span><span class="text-red-400" x-text="fmt(selectedDetail?.sisa)"></span></div>
              </div>
          </div>
      </div>
  </div>

  <script>
    // PERHATIAN: GANTI URL INI DENGAN DEPLOYMENT TERBARU ANDA
    const API_URL = "https://script.google.com/macros/s/AKfycbyCSAxVmEA3HDY7tJcB590rt_QsKs31lCv10UiHFpJ-itK0XKJfTPjcSeQNV1cI-_wV/exec"; 
    const API_TOKEN = "GROW_SECURE_2024"; 

    function app(){
      return {
        currentUser: JSON.parse(localStorage.getItem('grow_user')) || null,
        loginForm: { u: '', p: '' },
        isLogoutOpen: false, isDetailOpen: false, loadingDetail: false, selectedDetail: null, detailItems: [],
        
        tab:'home', initialLoading:true, bgProcess:false, loadingPdf:false, notifications:[], isMasterOpen:false, isSetorOpen:false, isDeleteOpen:false, deleteId:null, isOffline: false, loadingData: true,
        allProducts:[], categories:[], history:[], expenses:[], stats:{omzet:0,grossProfit:0,netProfit:0,totalExpense:0}, modalStats:{modalGantung:0, totalHPP:0}, filterDate:'', isService:false, selectedCategory:"", filterStatus:'', productSearch: '', showProductList: false,
        form:{id:null,customer:'',productName:'',serviceName:'',qty:1,sellPrice:'',costPrice:'',dp:0,deadline:''}, newProd:{category:'',name:''}, setorForm:{amount:'',note:''}, expForm:{category:'',desc:'',amount:''},
        cart: [], loadingText: 'MENGHUBUNGKAN...', loadingMessages: ['MENYAMBUNGKAN SERVER...', 'SINKRONISASI DATA...', 'MEMUAT DASHBOARD...', 'MENYIAPKAN TRANSAKSI...'], timeString: '', dateString: '',

        init(){ 
            setInterval(() => this.updateTime(), 1000); this.updateTime();
            let msgIndex = 0; const msgInterval = setInterval(() => { this.loadingText = this.loadingMessages[msgIndex]; msgIndex = (msgIndex + 1) % this.loadingMessages.length; }, 800);
            window.addEventListener('offline', () => this.isOffline = true); window.addEventListener('online', () => this.isOffline = false);
            
            const savedCart = localStorage.getItem('grow_cart_backup');
            if (savedCart) { this.cart = JSON.parse(savedCart); if(this.cart.length>0) this.notify("Keranjang dipulihkan", 'info'); }
            this.$watch('cart', (val) => localStorage.setItem('grow_cart_backup', JSON.stringify(val)));

            if (this.currentUser) { this.startApp(msgInterval); } else { this.initialLoading = false; clearInterval(msgInterval); }
        },

        updateTime() { const now = new Date(); this.timeString = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' }); this.dateString = now.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }); },
        get greeting() { const h = new Date().getHours(); if(h<11) return 'Selamat Pagi'; if(h<15) return 'Selamat Siang'; if(h<18) return 'Selamat Sore'; return 'Selamat Malam'; },
        startApp(interval) { fetch(`${API_URL}?action=ping`, { mode: 'no-cors' }); this.fetch(true).then(() => { if(interval) clearInterval(interval); }); },
        vibrate() { if (navigator.vibrate) navigator.vibrate(50); },

        async login() {
            if(!this.loginForm.u || !this.loginForm.p) return this.notify("Isi Username & Password!", 'error');
            this.bgProcess = true;
            try {
                const response = await fetch(`${API_URL}?action=login`, { method: 'POST', redirect: "follow", headers: {"Content-Type": "text/plain;charset=utf-8"}, body: JSON.stringify({ username: this.loginForm.u, password: this.loginForm.p }) });
                const res = await response.json();
                if (res.success) { this.currentUser = res.user; localStorage.setItem('grow_user', JSON.stringify(res.user)); this.loginForm = { u: '', p: '' }; this.initialLoading = true; this.startApp(); } else { this.notify(res.message, 'error'); }
            } catch (e) { this.notify("Gagal Login: Server Error", 'error'); }
            this.bgProcess = false;
        },
        logout() { this.isLogoutOpen = false; localStorage.removeItem('grow_user'); this.currentUser = null; this.tab = 'home'; },
        getTodayFormatted() { return this.dateString; },
        notify(e,t='success'){ const n=Date.now(); this.notifications.push({id:n,message:e,type:t}); setTimeout(()=>this.notifications=this.notifications.filter(e=>e.id!==n),1500); },

        async api(action, payload = null) {
            if(navigator.onLine === false) { this.notify("Anda sedang Offline!", 'error'); return null; }
            const url = `${API_URL}?action=${action}`; const bodyData = payload || {}; bodyData.token = API_TOKEN; 
            try { const response = await fetch(url, { method: 'POST', redirect: "follow", headers: {"Content-Type": "text/plain;charset=utf-8"}, body: JSON.stringify(bodyData) }); const data = await response.json(); if(data && data.success === false && data.message.includes("Token")) { this.notify("Akses Ditolak: Token API Salah", 'error'); return null; } return data; } catch (error) { console.error("API Error:", error); this.notify("Koneksi Gagal/Timeout", 'error'); return null; }
        },

        async fetch(isInitial = false){
            if(isInitial) { this.initialLoading = true; this.loadingData = true; }
            const e = await this.api('getInitialData');
            if(e) { this.allProducts=e.products || []; this.categories=[...new Set(this.allProducts.map(p=>p.category))]; this.history=e.history || []; this.expenses=e.expenses || []; this.modalStats=e.modalStats || {modalGantung:0, totalHPP:0}; this.stats=e.stats || {omzet:0,grossProfit:0,netProfit:0,totalExpense:0}; this.initialLoading=false; this.loadingData=false; } else { this.initialLoading=false; this.loadingData=false; }
        },

        get filteredProducts(){ 
            if (!this.productSearch) return [];
            const lower = this.productSearch.toLowerCase();
            return this.allProducts.filter(p => p.name.toLowerCase().includes(lower) || p.category.toLowerCase().includes(lower)).slice(0, 10);
        },
        get filteredHistory(){ 
            return this.history.filter(e => {
                const matchDate = this.filterDate ? e.isoDate === this.filterDate : true;
                const matchStatus = this.filterStatus ? e.status === this.filterStatus : true;
                return matchDate && matchStatus;
            }); 
        },
        get cartTotal(){ return this.cart.reduce((acc, item) => acc + (item.qty * item.sellPrice), 0); },

        daysLeft(e){ if(!e)return{text:'',class:''}; const t=new Date;t.setHours(0,0,0,0); const a=new Date(e),n=Math.ceil((a-t)/864e5); if(n<0)return{text:'LEWAT!',class:'bg-red-600 text-white animate-pulse'}; if(0===n)return{text:'HARI INI!',class:'bg-red-500 text-white animate-bounce'}; if(1===n)return{text:'BESOK',class:'bg-orange-100 text-orange-700'}; if(n<=3)return{text:`H-${n}`,class:'bg-amber-100 text-amber-700'}; const o=new Date(e),r=o.getDate(),s=["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Ags","Sep","Okt","Nov","Des"]; return{text:`${r} ${s[o.getMonth()]}`,class:'bg-slate-100 text-slate-500'} },

        addToCart(){
            const e=this.isService?"[JASA] "+this.form.serviceName:this.form.productName; const t=this.isService?0:this.form.costPrice;
            if(!e){ this.notify("Pilih Produk/Isi Nama Jasa",'error'); return; } if(!this.isService && (!t || t <= 0)) { this.notify("Harga Modal Wajib Diisi!", 'error'); return; } if(!this.form.qty || this.form.qty <= 0) { this.notify("Qty minimal 1", 'error'); return; } if(!this.form.sellPrice) { this.notify("Harga Jual Wajib Diisi", 'error'); return; }
            this.cart.push({productName: e,qty: parseFloat(this.form.qty),sellPrice: parseFloat(this.form.sellPrice),costPrice: parseFloat(t)});
            this.form.productName = ''; this.form.serviceName = ''; this.form.qty = 1; this.form.sellPrice = ''; this.form.costPrice = '';
            this.productSearch = ''; // Reset search
        },

        async save(){
            this.vibrate();
            if(this.cart.length === 0) return this.notify("Keranjang Kosong", 'error');
            this.bgProcess=true;
            const res = await this.api('saveTransaction', { id:this.form.id, customer:this.form.customer, items: this.cart, dp:this.form.dp, deadline:this.form.deadline });
            this.bgProcess=false;
            if(res && res.success){ 
                this.notify("Transaksi Tersimpan!"); 
                this.resetForm(); 
                this.cart = []; // Clear Cart
                localStorage.removeItem('grow_cart_backup'); // Clear Backup
                this.tab='home'; 
                this.fetch(); 
            } else { this.notify("Gagal: " + (res?.message || "Server Error"), 'error'); }
        },

        async submitExpense(){
            if(!this.expForm.amount||this.expForm.amount<=0)return this.notify("Nominal Salah",'error');
            this.bgProcess=true; const res = await this.api('saveExpense', this.expForm); this.bgProcess=false;
            if(res && res.success){ this.expForm={category:'',desc:'',amount:''}; this.notify("Biaya Disimpan"); this.fetch(); } else { this.notify(res ? res.message : "Gagal", 'error') }
        },

        async viewDetail(t) {
            this.selectedDetail = t; this.detailItems = []; this.isDetailOpen = true; this.loadingDetail = true;
            const res = await this.api('getTransactionDetail', { id: t.id, date: t.isoDate });
            if(res && res.success) { this.detailItems = res.items; } else { this.notify("Gagal memuat detail", 'error'); }
            this.loadingDetail = false;
        },

        async editItem(t){
            this.form.id = t.id; this.form.customer = t.customer; this.form.deadline = t.deadline || ''; this.form.dp = t.dp; this.cart = []; this.tab = 'add'; this.bgProcess = true; 
            const res = await this.api('getTransactionDetail', { id: t.id, date: t.isoDate }); this.bgProcess = false;
            if (res && res.success) { this.cart = res.items; } else { this.notify("Gagal memuat: " + (res ? res.message : "Error"), "error"); }
        },

        requestDelete(id){ this.deleteId=id; this.isDeleteOpen=true; },
        async confirmDelete(){ this.isDeleteOpen=false; this.bgProcess=true; const res = await this.api('deleteTransaction', { id: this.deleteId }); this.bgProcess=false; if(res && res.success){ this.notify("Data Terhapus"); this.fetch(); } else { this.notify("Gagal Hapus", 'error'); } },

        async printInvoice(id){ this.loadingPdf=true; this.handlePDF(await this.api('generateInvoice', { id: id })); }, 
        async printMonthly(){ this.loadingPdf=true; this.handlePDF(await this.api('generatePDFReport')); },
        async printAnnual(){ this.loadingPdf=true; const e=new Date().getFullYear(); this.handlePDF(await this.api('generateAnnualReport', { year: e })); },
        async printExpenseReport(){ this.loadingPdf=true; this.handlePDF(await this.api('generateExpenseOnlyReport')); },
        handlePDF(e){ this.loadingPdf=false; if(e && e.success){ const link=document.createElement('a'); link.href=e.data; link.download=e.filename; document.body.appendChild(link); link.click(); document.body.removeChild(link); } else { this.notify("Gagal PDF: "+(e?e.message:"Error"),'error') } },

        async submitNewProd(){ this.bgProcess=true; const res = await this.api('addNewProduct', { category: this.newProd.category, name: this.newProd.name }); this.bgProcess=false; if(res && res.success){ this.isMasterOpen=false; this.newProd={category:'',name:''}; this.notify("Produk Berhasil Ditambah"); this.fetch(); } else { this.notify(res.message,'error') } },
        async submitSetor(){ this.bgProcess=true; const res = await this.api('saveDeposit', { amount: this.setorForm.amount, note: this.setorForm.note }); this.isSetorOpen=false; this.bgProcess=false; if(res && res.success){ this.notify("Setor Modal Berhasil"); this.fetch(); } else { this.notify(res.message,'error') } },
        openSetorModal(){ this.setorForm.amount=this.modalStats.modalGantung; this.isSetorOpen=true; },
        resetForm(){ this.isService=false; this.selectedCategory=""; this.cart=[]; this.form={id:null,customer:'',productName:'',serviceName:'',qty:1,sellPrice:'',costPrice:'',dp:0,deadline:''}; },
        fmt(e){ return new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',minimumFractionDigits:0}).format(e||0) }
      }
    }
  </script>
</body>
</html>